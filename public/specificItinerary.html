<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Itinerary</title>
    <script src="https://kit.fontawesome.com/2c4b6f2b7b.js" crossorigin="anonymous"></script>
</head>

<body>
    <header>
        <h1 id="header">TravelShare Itinerary</h1>
    </header>

    <div id="container">
        <button onclick="navigatePage()"><i class="fa-solid fa-house"></i> Main Page</button>
        <h1>Itinerary Details</h1>
        <div id="itineraryDetails">
            <!-- Itinerary details will be populated here -->
        </div>
        <button id="likeButton" class="like-button">Like</button>
        <span id="likeCount">0</span> likes
        <!-- Comment -->
        <input type="text" id="comment" placeholder="Add a comment"></input>
        <button id="comment_btn" onclick="addComment()">Submit</button>
        <div id="comment_feed">
            <h3>Comments:</h3>
        </div>
    </div>

    <footer>
        <h5 id="footer">&copy; TravelShare, 2023.</h5>
    </footer>

    <script>
        var id;
        window.onload = async function () {
            const urlParams = new URLSearchParams(window.location.search);
            id = urlParams.get('id');
            await fetchItineraryDetails();
        }

        // Fetches and displays the itinerary details
        async function fetchItineraryDetails() {
            try {
                const response = await fetch(`http://localhost:3000/itineraries/${id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const itinerary = await response.json();
                const itineraryDiv = document.getElementById('itineraryDetails');
                const commentDiv = document.getElementById('comment_feed');
                // Populate itinerary details
                const imageFile = document.createElement('img');
                imageFile.src = itinerary.image;
                itineraryDiv.appendChild(imageFile);

                const destination = document.createElement('h2');
                destination.textContent = `Destination: ${itinerary.destination}`;
                itineraryDiv.appendChild(destination);

                const startDate = document.createElement('p');
                startDate.textContent = `Start Date: ${itinerary.startDate}`;
                itineraryDiv.appendChild(startDate);

                const endDate = document.createElement('p');
                endDate.textContent = `End Date: ${itinerary.endDate}`;
                itineraryDiv.appendChild(endDate);

                const activitiesTitle = document.createElement('h3');
                activitiesTitle.textContent = 'Activities:';
                itineraryDiv.appendChild(activitiesTitle);

                const activitiesList = document.createElement('ul');
                itinerary.activities.forEach(activity => {
                    const activityItem = document.createElement('li');
                    const activityDate = new Date(activity.date);
                    const formattedDate = `${activityDate.getFullYear()}-${(activityDate.getMonth() + 1).toString().padStart(2, '0')}-${activityDate.getDate().toString().padStart(2, '0')}`;
                    activityItem.textContent = `${activity.description} (Date: ${formattedDate})`;
                    activitiesList.appendChild(activityItem);
                });
                itineraryDiv.appendChild(activitiesList);

                const expensesTitle = document.createElement('h3');
                expensesTitle.textContent = 'Expenses:';
                itineraryDiv.appendChild(expensesTitle);

                const expensesList = document.createElement('ul');
                itinerary.expenses.forEach(expense => {
                    const expenseItem = document.createElement('li');
                    expenseItem.textContent = `${expense.description}: $${expense.amount.toFixed(2)}`;
                    expensesList.appendChild(expenseItem);
                });
                itineraryDiv.appendChild(expensesList);

                // Display comments
                // const commentsTitle = document.createElement('h3');
                // commentsTitle.textContent = 'Comments:';
                // itineraryDiv.appendChild(commentsTitle);

                // const commentsList = document.createElement('ul');
                // itinerary.comments.forEach(comment => {
                //     const commentItem = document.createElement('li');
                //     commentItem.textContent = `${comment.username}: ${comment.text}`;
                //     commentsList.appendChild(commentItem);
                // });
                // itineraryDiv.appendChild(commentsList);
                itinerary.comments.forEach(comments => {
                        const commentFeed = document.createElement('p');
                        commentFeed.id = `comment_${comments._id}`;

                        const commentWrapper = document.createElement('div');
                        commentWrapper.setAttribute('class', 'commentWrapper');



                        
                        const delComment = document.createElement('button');
                        delComment.textContent = "Delete";
                        delComment.id = "del_comment";
                        delComment.onclick = () => deleteComment(comments._id);
                        fetch(`http://localhost:3000/user/${comments.user}`)
                        .then(response => response.json())
                        .then(user => {
                            commentFeed.textContent = `${user.fName} ${user.lName}: ${comments.text}`;
                        })
                        .catch(error => console.error(error));
                        commentWrapper.appendChild(commentFeed);
                        // commentDiv.appendChild(commentFeed);
                        if(comments.user == sessionStorage.getItem('userId'))
                            commentWrapper.appendChild(delComment);
                            // commentDiv.appendChild(delComment);
                        commentDiv.appendChild(commentWrapper);
                    });

            } catch (error) {
                console.error('Error fetching itinerary details:', error);
                const itineraryDiv = document.getElementById('itineraryDetails');
                itineraryDiv.textContent = "Error loading itinerary details.";
            }
        }

        function addComment() {
            const comment = document.getElementById("comment").value;
            const userId = sessionStorage.getItem('userId');

            fetch(`http://localhost:3000/itineraries/${id}/addComment`, {
                method: 'PUT',
                headers: {
                    'Content-type': 'application/json',
                },
                body: JSON.stringify({ commentText: comment, userId: userId }),
            })
            .then(response => response.json())
            .then(commentData => {
                console.log('Comment successfully posted:', commentData);
                location.reload(); // Refresh the page to display the new comment
            })
            .catch(error => console.error('Error adding comment:', error));
        }

        function deleteComment(commentId) {
            fetch(`http://localhost:3000/itineraries/${id}/deleteComment/${commentId}`, {
                method: 'PUT',
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                location.reload();
            })
            .catch(error => console.error(error));
        }

        function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
        }

        const likeButton = document.getElementById('likeButton');
        const likeCountSpan = document.getElementById('likeCount');
        let isLiked = false;
        let likeCount = 0;

        function toggleLikeItinerary() {
        const itineraryId = getQueryParam('id');
        const currentUserId = sessionStorage.getItem('userId') || 'user-id-placeholder'; // Use 'currentUserId' instead of 'userId'

        // Toggle the isLiked state 
        isLiked = !isLiked;
        // Optimistically update the UI
        likeCountSpan.textContent = isLiked ? ++likeCount : --likeCount;
        likeButton.classList.toggle('liked', isLiked);

        fetch(`http://localhost:3000/itineraries/${itineraryId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Include other headers such as Authorization if needed
            },
            body: JSON.stringify({ userId: currentUserId, like: isLiked }) // Corrected variable name here
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .catch(error => {
            console.error('Error updating like status:', error);
            // Revert the optimistic UI update on error
            likeCountSpan.textContent = isLiked ? --likeCount : ++likeCount;
            likeButton.classList.toggle('liked', isLiked);
            isLiked = !isLiked;
        });
        }

        likeButton.addEventListener('click', toggleLikeItinerary);

        function navigatePage() {
            window.location.href = 'mainPage.html';
        }
    </script>

</body>

</html>
