<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Profile</title>
    <link rel="stylesheet" href="editprofile.css" />
  </head>
  <body>
    <header>
      <div class="header-container">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          id="map-marker"
        >
          <path
            fill="#F1090A"
            d="M12,2a8,8,0,0,0-8,8c0,5.4,7.05,11.5,7.35,11.76a1,1,0,0,0,1.3,0C13,21.5,20,15.4,20,10A8,8,0,0,0,12,2Zm0,17.65c-2.13-2-6-6.31-6-9.65a6,6,0,0,1,12,0C18,13.34,14.13,17.66,12,19.65ZM12,6a4,4,0,1,0,4,4A4,4,0,0,0,12,6Zm0,6a2,2,0,1,1,2-2A2,2,0,0,1,12,12Z"
          ></path>
        </svg>
        <h1 id="header">TravelShare - Edit Profile</h1>

        <div id="header-button">
          <button onclick="navigateBack()">Cancel</button>
        </div>
      </div>
    </header>

    <div id="editProfileContainer">
      <form id="editProfileForm">
        <label for="fName">First Name:</label><br />
        <input type="text" id="fName" name="fName" required /><br />

        <label for="lName">Last Name:</label><br />
        <input type="text" id="lName" name="lName" required /><br />

        <label for="password">New Password (optional):</label><br />
        <input type="password" id="password" name="password" /><br />

        <input type="submit" value="Update Profile" />
      </form>
    </div>

    <footer>
      <h5>&copy; TravelShare, 2024</h5>
    </footer>

    <script>
      async function navigateBack() {
        window.location.href = "profile.html"; // Redirect back to the profile page
      }

      async function fetchCurrentUserData() {
        const userId = sessionStorage.getItem("userId");
        if (!userId) {
          alert("You must be logged in to edit your profile.");
          navigateBack();
          return;
        }

        try {
          const response = await fetch(`http://localhost:3000/user/${userId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const userData = await response.json();

          document.getElementById("fName").value = userData.fName;
          document.getElementById("lName").value = userData.lName;
          // The password field is intentionally not populated for security reasons
        } catch (error) {
          console.error("Error fetching current user data:", error);
          // Handle errors (e.g. by showing a message to the user)
        }
      }

      document
        .getElementById("editProfileForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const userId = sessionStorage.getItem("userId");
          const updatedData = {
            fName: document.getElementById("fName").value,
            lName: document.getElementById("lName").value,
            // Include password only if it's being changed
            ...(document.getElementById("password").value && {
              password: document.getElementById("password").value,
            }),
          };

          try {
            const response = await fetch(
              `http://localhost:3000/user/${userId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  // Additional security measures should be implemented such as authorization headers
                },
                body: JSON.stringify(updatedData),
              }
            );

            if (!response.ok) {
              throw new Error("HTTP error! Status: " + response.status);
            }

            const result = await response.json();
            console.log("Profile updated successfully:", result);
            navigateBack(); // Redirect back to the profile page
          } catch (error) {
            console.error("Error updating profile:", error);
            // Handle errors (e.g. by showing a message to the user)
          }
        });

      window.addEventListener("DOMContentLoaded", fetchCurrentUserData);
    </script>
  </body>
</html>
